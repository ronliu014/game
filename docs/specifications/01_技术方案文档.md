# 技术方案文档

**项目名称**：修复电路板小游戏
**文档版本**：v1.0
**创建日期**：2026-01-17
**目标平台**：Windows桌面应用

---

## 1. 技术栈选型

### 1.1 核心技术决策

| 技术领域 | 选型方案 | 理由 |
|---------|---------|------|
| **编程语言** | Python 3.x | 符合现有conda环境配置，开发效率高 |
| **游戏引擎** | Pygame 2.5+ | 成熟稳定，2D游戏标准方案，文档丰富 |
| **开发环境** | conda环境 `Game` | 已配置环境，路径：`D:\anaconda3\envs\Game` |
| **打包工具** | PyInstaller | 可打包为独立exe，无需Python运行时 |
| **版本控制** | Git | 标准版本管理工具 |
| **配置格式** | JSON | 关卡数据、游戏配置的存储格式 |

### 1.2 技术栈对比分析

#### 为什么选择 Pygame 而不是其他方案？

| 方案 | 优势 | 劣势 | 适用性评分 |
|-----|------|------|-----------|
| **Pygame** ✅ | • 轻量级，学习曲线平缓<br>• 完全控制渲染逻辑<br>• 打包简单<br>• 社区活跃 | • 需要手动实现UI组件<br>• 性能不如原生引擎 | ⭐⭐⭐⭐⭐ |
| Arcade | • 更现代的API<br>• 内置物理引擎 | • 社区较小<br>• 文档不如Pygame完善 | ⭐⭐⭐⭐ |
| Unity | • 强大的编辑器<br>• 完整的工具链 | • 学习成本高<br>• 打包体积大<br>• 对简单2D游戏过度设计 | ⭐⭐ |
| Godot | • 开源免费<br>• 2D性能优秀 | • 需要学习GDScript<br>• 不符合现有Python环境 | ⭐⭐ |
| H5 (Phaser) | • 跨平台部署 | • 不符合"独立桌面应用"需求 | ⭐ |

**最终决策**：Pygame 最符合当前需求（个人开发 + Python环境 + 桌面应用 + 1周MVP）

---

## 2. 系统架构设计

### 2.1 整体架构（MVC模式）

```
┌─────────────────────────────────────────────────────────┐
│                      Main Game Loop                      │
│                    (main.py - 60 FPS)                    │
└────────────┬────────────────────────────────┬───────────┘
             │                                │
    ┌────────▼────────┐              ┌────────▼────────┐
    │  Input Handler  │              │  Render Engine  │
    │  (events.py)    │              │  (renderer.py)  │
    └────────┬────────┘              └────────▲────────┘
             │                                │
    ┌────────▼────────────────────────────────┴────────┐
    │              Game State Manager                   │
    │              (game_state.py)                      │
    └────────┬──────────────────────────────────────────┘
             │
    ┌────────▼────────┐    ┌──────────────┐    ┌──────────────┐
    │   Grid System   │    │ Level Manager│    │  UI Manager  │
    │   (grid.py)     │    │ (levels.py)  │    │  (ui.py)     │
    └────────┬────────┘    └──────┬───────┘    └──────────────┘
             │                    │
    ┌────────▼────────┐    ┌──────▼───────┐
    │  Tile (model)   │    │ Level Data   │
    │  (tile.py)      │    │ (JSON files) │
    └─────────────────┘    └──────────────┘
```

### 2.2 核心模块职责

#### **Model 层（数据模型）**
- `tile.py`：单个方块的数据结构（类型、旋转角度、是否可点击）
- `grid.py`：网格系统，管理所有方块，实现连通性判定算法
- `level.py`：关卡数据模型，从JSON加载关卡配置

#### **View 层（渲染）**
- `renderer.py`：负责所有绘制逻辑（方块、特效、UI）
- `assets.py`：资源管理器（图片、音效加载与缓存）
- `effects.py`：特效系统（发光、闪烁、粒子效果）

#### **Controller 层（逻辑控制）**
- `game_state.py`：游戏状态机（菜单、游戏中、通关、暂停）
- `input_handler.py`：处理鼠标点击、键盘输入
- `level_manager.py`：关卡加载、切换、进度管理

---

## 3. 项目目录结构

```
game/
├── main.py                      # 程序入口，主循环
├── requirements.txt             # Python依赖清单
├── config.py                    # 全局配置（窗口大小、FPS等）
│
├── src/                         # 源代码目录
│   ├── __init__.py
│   ├── core/                    # 核心游戏逻辑
│   │   ├── __init__.py
│   │   ├── tile.py              # 方块类定义
│   │   ├── grid.py              # 网格系统 + 连通性算法
│   │   ├── level.py             # 关卡数据模型
│   │   └── connectivity.py      # 电路连通性判定算法（BFS/DFS）
│   │
│   ├── managers/                # 管理器模块
│   │   ├── __init__.py
│   │   ├── game_state.py        # 游戏状态管理
│   │   ├── level_manager.py     # 关卡加载与切换
│   │   ├── asset_manager.py     # 资源加载与缓存
│   │   └── audio_manager.py     # 音效与BGM管理
│   │
│   ├── rendering/               # 渲染层
│   │   ├── __init__.py
│   │   ├── renderer.py          # 主渲染器
│   │   ├── effects.py           # 特效系统（发光、粒子）
│   │   └── ui.py                # UI组件（按钮、提示框）
│   │
│   ├── input/                   # 输入处理
│   │   ├── __init__.py
│   │   └── input_handler.py     # 鼠标/键盘事件处理
│   │
│   └── utils/                   # 工具函数
│       ├── __init__.py
│       ├── constants.py         # 常量定义（颜色、尺寸）
│       └── helpers.py           # 辅助函数（坐标转换等）
│
├── assets/                      # 资源文件
│   ├── images/                  # 图片资源
│   │   ├── tiles/               # 方块贴图
│   │   │   ├── power_source.png
│   │   │   ├── terminal_off.png
│   │   │   ├── terminal_on.png
│   │   │   ├── line.png         # 直线（可旋转）
│   │   │   ├── corner.png       # 转角（可旋转）
│   │   │   └── tile_bg.png      # 可点击方块背景
│   │   ├── ui/                  # UI元素
│   │   │   ├── hint_box.png
│   │   │   ├── btn_exit.png
│   │   │   └── victory_banner.png
│   │   └── effects/             # 特效贴图
│   │       └── glow.png
│   │
│   ├── sounds/                  # 音效文件
│   │   ├── click.wav            # 点击音效
│   │   ├── rotate.wav           # 旋转音效
│   │   ├── connect.wav          # 电路连通音效
│   │   └── victory.wav          # 通关音效
│   │
│   └── fonts/                   # 字体文件
│       └── default.ttf
│
├── data/                        # 游戏数据
│   ├── levels/                  # 关卡配置文件
│   │   ├── level_001.json
│   │   ├── level_002.json
│   │   └── level_003.json
│   └── config.json              # 游戏配置（音量、窗口设置等）
│
├── docs/                        # 文档目录（已存在）
│   ├── 派对游戏 - 修复电路板_设计文档.md
│   ├── 01_技术方案文档.md       # 本文档
│   ├── 02_GDD-游戏设计文档.md   # 待生成
│   ├── 03_美术资源清单.md       # 待生成
│   ├── 04_开发任务拆解表.md     # 待生成
│   └── 05_测试用例文档.md       # 待生成
│
└── build/                       # 打包输出目录（PyInstaller生成）
    └── game.exe
```

---

## 4. 核心算法设计

### 4.1 电路连通性判定算法

**算法选择**：广度优先搜索（BFS）

**实现思路**：
```python
def check_connectivity(grid, start_pos, end_pos):
    """
    检查从电源端到终端是否存在有效电路路径

    Args:
        grid: 网格对象
        start_pos: 电源端坐标 (x, y)
        end_pos: 终端坐标 (x, y)

    Returns:
        bool: 是否连通
        list: 连通路径（用于绘制发光特效）
    """
    from collections import deque

    queue = deque([(start_pos, [start_pos])])
    visited = {start_pos}

    while queue:
        (x, y), path = queue.popleft()

        if (x, y) == end_pos:
            return True, path  # 找到路径

        # 获取当前方块的出口方向
        current_tile = grid.get_tile(x, y)
        exits = current_tile.get_exit_directions()

        # 检查每个出口方向的邻居
        for direction in exits:
            nx, ny = get_neighbor(x, y, direction)

            if (nx, ny) not in visited and grid.is_valid_pos(nx, ny):
                neighbor_tile = grid.get_tile(nx, ny)

                # 检查邻居方块是否有对应的入口
                if neighbor_tile.has_entrance_from(opposite_direction(direction)):
                    visited.add((nx, ny))
                    queue.append(((nx, ny), path + [(nx, ny)]))

    return False, []  # 未找到路径
```

**关键点**：
- 每个方块根据类型和旋转角度有不同的出口方向
- 直线方块：2个出口（相对方向）
- 转角方块：2个出口（相邻方向）
- 电源端：1个出口
- 终端：1个入口

### 4.2 方块旋转逻辑

```python
class Tile:
    def rotate_clockwise(self):
        """顺时针旋转90度"""
        self.rotation = (self.rotation + 90) % 360
        self._update_exit_directions()

    def _update_exit_directions(self):
        """根据旋转角度更新出口方向"""
        base_exits = self.get_base_exits()  # 获取0度时的出口
        self.exits = [rotate_direction(d, self.rotation) for d in base_exits]
```

---

## 5. 性能优化策略

### 5.1 渲染优化
- **脏矩形更新**：只重绘发生变化的区域
- **资源预加载**：游戏启动时加载所有资源到内存
- **图片缓存**：旋转后的图片缓存，避免重复计算

### 5.2 内存优化
- **单例模式**：资源管理器使用单例，避免重复加载
- **对象池**：特效粒子使用对象池复用

### 5.3 目标性能指标
- **帧率**：稳定60 FPS
- **启动时间**：< 2秒
- **内存占用**：< 100MB
- **exe大小**：< 50MB

---

## 6. 开发工具链配置

### 6.1 环境配置

```bash
# 激活conda环境
conda activate Game

# 安装依赖
pip install pygame==2.5.2
pip install pyinstaller==6.3.0

# 验证安装
python -c "import pygame; print(pygame.version.ver)"
```

### 6.2 依赖清单（requirements.txt）

```
pygame==2.5.2
pyinstaller==6.3.0
```

### 6.3 打包命令

```bash
# 开发阶段运行
python main.py

# 打包为exe（单文件模式）
pyinstaller --onefile --windowed --icon=assets/icon.ico main.py

# 打包为exe（文件夹模式，启动更快）
pyinstaller --onedir --windowed --icon=assets/icon.ico main.py
```

---

## 7. 技术风险与应对

| 风险项 | 风险等级 | 应对方案 |
|-------|---------|---------|
| Pygame性能不足以支持复杂特效 | 🟡 中 | MVP阶段使用简单特效，后期可考虑OpenGL加速 |
| PyInstaller打包后exe体积过大 | 🟢 低 | 使用UPX压缩，移除不必要的依赖 |
| 连通性算法在复杂关卡中性能问题 | 🟢 低 | BFS算法复杂度O(n)，4x4网格完全可控 |
| 美术资源制作耗时超预期 | 🟡 中 | MVP使用占位符，后期迭代美术 |
| 跨平台兼容性问题 | 🟢 低 | 当前仅需支持Windows，风险可控 |

---

## 8. 技术债务管理

### 8.1 MVP阶段允许的技术债务
- ✅ 硬编码部分配置（后期改为配置文件）
- ✅ 简化的UI系统（后期可引入pygame-gui）
- ✅ 基础的音效管理（后期可支持音量调节、静音）

### 8.2 必须避免的技术债务
- ❌ 核心算法逻辑混乱（连通性判定必须清晰）
- ❌ 资源管理混乱（必须统一管理，避免内存泄漏）
- ❌ 代码结构混乱（必须遵循MVC分层）

---

## 9. 后续扩展性考虑

### 9.1 预留的扩展点
- **关卡编辑器**：可通过JSON手动编辑，未来可开发可视化编辑器
- **多语言支持**：UI文本预留国际化接口
- **成就系统**：预留统计接口（步数、时间）
- **关卡包系统**：支持从外部加载关卡包

### 9.2 不在当前范围的功能
- ❌ 在线排行榜
- ❌ 多人对战模式
- ❌ 关卡分享社区
- ❌ 移动端适配

---

## 10. 技术决策记录

| 日期 | 决策内容 | 理由 | 决策人 |
|------|---------|------|-------|
| 2026-01-17 | 选择Pygame作为游戏引擎 | 符合Python环境，开发效率高 | 项目组 |
| 2026-01-17 | 采用MVC架构模式 | 代码结构清晰，易于维护 | 项目组 |
| 2026-01-17 | 使用JSON存储关卡数据 | 易于编辑，支持版本控制 | 项目组 |
| 2026-01-17 | 目标平台锁定Windows桌面 | 符合"独立桌面应用"需求 | 项目组 |

---

**文档状态**：✅ 已完成
**下一步**：生成《GDD-游戏设计文档》
