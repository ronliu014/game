# 游戏设计文档更新说明

**更新日期**: 2026-01-23
**更新版本**: V3 算法版本
**文档**: `docs/design/派对游戏 - 修复电路板_设计文档.md`

---

## 📋 更新概述

本次更新修正了游戏设计文档中的核心玩法逻辑，反映了从固定关卡配置到动态生成算法的重大变更。

---

## 🔄 主要变更内容

### 1. 游戏定位（第1节）

#### 变更前 ❌
- 有固定的关卡数量
- 在被调用时可控制选择某一关或某几关

#### 变更后 ✅
- 支持无限模式，关卡动态生成，永不重复
- 提供四个难度级别（简单、普通、困难、地狱）
- 在被调用时可选择难度

**变更原因**: 游戏已从固定配置文件改为动态生成算法，支持无限关卡。

---

### 2. 关卡设计（第5节）- 核心变更

#### 变更前 ❌
简单描述了关卡实现的3个步骤：
1. 设定关卡大小
2. 定义每个方块使用的元素和旋转角度
3. 将某几个方块刻意旋转错误

**问题**:
- 没有说明如何确定方块配置
- 缺少精灵旋转定义
- 没有方向判断逻辑
- 缺少难度系统说明

#### 变更后 ✅
详细描述了 V3 生成算法的完整流程：

**5.2.1 核心算法流程**
1. 选择端点位置（确保距离 ≥ 2）
2. 路径查找（DFS算法，非最短路径）
3. 确定方块配置（基于相对位置）
4. 难度验证
5. 打乱方块

**5.2.2 坐标系统定义**
- 明确定义屏幕坐标系（X右Y下）
- 原点在左上角

**5.2.3 精灵旋转定义**
- 直线精灵：0°/90°/180°/270° 的具体含义
- 拐角精灵：0°/90°/180°/270° 的具体含义
- 使用 Unicode 字符可视化（└┌┐┘）

**5.2.4 方块配置逻辑**
- 详细说明如何根据前一个、当前、下一个方块的相对位置确定配置
- 提供具体示例
- 明确方向判断规则（`prev_x < cur_x` → 前一个在左方）

**5.2.5 难度系统**
- 四个难度级别的详细参数表
- 网格大小、可移动方块、拐角数量、打乱比例

**变更原因**:
- 修正了之前逻辑不清晰的问题
- 完整反映 V3 算法的实现细节
- 提供了可操作的技术规范

---

### 3. 通关流程设计（第8节）

#### 变更前 ❌
- 通关后提供"下一关"和"关闭游戏"选项
- 没有说明下一关如何生成

#### 变更后 ✅
- 增加了"每次旋转后自动检测电路连通性"
- 明确说明"自动生成下一关（保持当前难度）"
- 新增 **8.2 无限模式说明**：
  - 采用无限模式，通关后自动生成新关卡
  - 每个关卡都是动态生成的，永不重复
  - 关卡编号持续累加
  - 无需保存进度

**变更原因**: 反映无限模式的游戏机制。

---

## 🎯 技术规范要点

### 坐标系统
```
(0,0) ----→ X轴正方向
  |
  |
  ↓
Y轴正方向
```

### 精灵旋转
```
直线精灵:
0°:   ─  (水平)
90°:  │  (竖直)

拐角精灵:
0°:   └  (上→右)
90°:  ┌  (右→下)
180°: ┐  (下→左)
270°: ┘  (左→上)
```

### 方向判断
```python
# 关键规则（屏幕坐标系）
prev_x < cur_x  →  前一个在左方
prev_x > cur_x  →  前一个在右方
prev_y < cur_y  →  前一个在上方
prev_y > cur_y  →  前一个在下方
```

### 难度参数
| 难度 | 网格 | 可移动 | 拐角 | 打乱 |
|------|------|--------|------|------|
| 简单 | 4-5 | 3-6 | 1-3 | ≥70% |
| 普通 | 5-6 | 5-10 | 2-5 | ≥80% |
| 困难 | 6-7 | 8-15 | 3-8 | ≥90% |
| 地狱 | 7-8 | 12-20 | 5-12 | 100% |

---

## 📚 相关文档

### 技术实现文档
- `docs/ALGORITHM_V3_IMPLEMENTATION.md` - V3 算法详细实现说明
- `docs/V3_COMPLETION_REPORT.md` - V3 完成报告
- `docs/INFINITE_MODE_GUIDE.md` - 无限模式使用指南

### 代码文件
- `src/core/level/level_generator_v3.py` - 核心生成算法
- `src/core/level/difficulty_config.py` - 难度配置
- `src/core/level/level_manager.py` - 关卡管理器

### 测试文件
- `tests/integration/test_algorithm_verification.py` - 算法验证测试
- `tests/debug_scrambling.py` - 打乱逻辑测试
- `tests/quick_test_v3.py` - 快速测试

---

## ✅ 验证状态

所有更新已通过以下验证：

1. **算法正确性** ✅
   - 方向判断逻辑正确
   - 精灵旋转定义准确
   - 路径生成符合预期

2. **难度系统** ✅
   - 所有难度级别测试通过
   - 打乱比例符合要求
   - 网格大小和方块数量在合理范围

3. **无限模式** ✅
   - 关卡动态生成正常
   - 每次生成的关卡都不同
   - 难度保持一致

---

## 🎮 使用建议

### 对于开发人员
1. 阅读更新后的第5节"关卡设计"，理解 V3 算法
2. 参考 `ALGORITHM_V3_IMPLEMENTATION.md` 了解实现细节
3. 运行测试脚本验证算法正确性

### 对于美术/音效人员
1. 精灵旋转定义（5.2.3）是制作资源的重要参考
2. 确保资源符合 `docs/specifications/10_美术资源规范.md`
3. 确保资源符合 `docs/specifications/11_音效资源规范.md`

### 对于策划人员
1. 难度系统（5.2.5）可根据测试反馈调整参数
2. 无限模式说明（8.2）是设计关卡流程的依据
3. 可以基于玩家反馈优化难度曲线

---

## 📝 后续工作

### 建议更新的其他文档
1. `README.md` - 更新项目说明，反映无限模式
2. `docs/specifications/01_技术方案文档.md` - 更新技术架构说明
3. `docs/specifications/06_项目实施路线图.md` - 标记 V3 算法已完成

### 建议添加的内容
1. 关卡生成算法的可视化流程图
2. 精灵旋转的动画演示
3. 难度系统的平衡性分析报告

---

**更新人员**: Claude Code
**审核状态**: 待审核
**生效日期**: 2026-01-23

---

**注意**: 本文档记录了设计文档的重大变更，建议所有团队成员阅读并理解新的游戏逻辑。
