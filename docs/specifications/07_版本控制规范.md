# 版本控制规范

## 文档版本
- **版本号**: v1.0.0
- **创建日期**: 2026-01-20
- **最后更新**: 2026-01-20
- **文档状态**: 正式版

---

## 1. 概述

### 1.1 目的
本文档定义项目的版本控制策略，确保：
- 代码变更可追溯
- 阶段性成果可回滚
- 团队协作有序进行
- 发布流程规范化

### 1.2 适用范围
- 所有源代码
- 配置文件
- 文档资源
- 数据文件

---

## 2. 版本号规范

### 2.1 语义化版本号
采用 `主版本号.次版本号.修订号` 格式（Semantic Versioning 2.0.0）

```
v主版本号.次版本号.修订号[-预发布标识]

示例：
v1.0.0          # 正式版本
v0.3.0          # 开发版本
v1.0.0-beta.1   # 预发布版本
v0.1.0-stage0   # 阶段标记版本
```

### 2.2 版本号递增规则

| 版本位 | 递增时机 | 示例 |
|--------|---------|------|
| **主版本号** | 不兼容的API变更 | 1.0.0 → 2.0.0 |
| **次版本号** | 向下兼容的功能新增 | 1.0.0 → 1.1.0 |
| **修订号** | 向下兼容的问题修正 | 1.0.0 → 1.0.1 |

### 2.3 阶段性版本号映射

根据项目实施路线图，各阶段对应版本号：

| 阶段 | 版本号 | 标签名 | 说明 |
|------|--------|--------|------|
| 阶段0 | v0.1.0 | v0.1.0-stage0 | 环境搭建与技术选型 |
| 阶段1 | v0.2.0 | v0.2.0-stage1 | 核心框架开发 |
| 阶段2 | v0.3.0 | v0.3.0-stage2 | 游戏逻辑实现 |
| 阶段3 | v0.4.0 | v0.4.0-stage3 | 渲染与交互 |
| 阶段4 | v0.5.0 | v0.5.0-stage4 | 音效特效与优化 |
| 阶段5 | v0.9.0 | v0.9.0-stage5 | 集成测试与文档 |
| 阶段6 | v1.0.0 | v1.0.0 | 正式发布 |

---

## 3. 分支管理策略

### 3.1 分支模型
采用 **Git Flow** 简化版本：

```
main                    # 主分支（生产就绪）
  ├── develop           # 开发分支（集成分支）
  │   ├── feature/*     # 功能分支
  │   ├── bugfix/*      # 修复分支
  │   └── hotfix/*      # 紧急修复分支
  └── release/*         # 发布分支
```

### 3.2 分支说明

#### 3.2.1 主分支（main）
- **用途**: 存储生产就绪的代码
- **保护**: 禁止直接提交，只能通过PR合并
- **标签**: 每次发布打标签
- **生命周期**: 永久存在

**规则**:
- ✅ 只接受来自 `release/*` 或 `hotfix/*` 的合并
- ❌ 禁止直接push
- ✅ 每次合并必须打标签

#### 3.2.2 开发分支（develop）
- **用途**: 日常开发的集成分支
- **来源**: 从 `main` 创建
- **合并**: 接受 `feature/*` 和 `bugfix/*`
- **生命周期**: 永久存在

**规则**:
- ✅ 功能开发完成后合并到此分支
- ✅ 定期从 `main` 同步更新
- ✅ 保持可编译、可运行状态

#### 3.2.3 功能分支（feature/*）
- **命名**: `feature/阶段-功能名`
- **示例**: `feature/stage1-logger`, `feature/stage2-grid-system`
- **来源**: 从 `develop` 创建
- **合并**: 合并回 `develop`
- **生命周期**: 功能完成后删除

**工作流程**:
```bash
# 1. 创建功能分支
git checkout develop
git pull origin develop
git checkout -b feature/stage1-logger

# 2. 开发并提交
git add .
git commit -m "feat(logger): implement structured logging system"

# 3. 合并回develop
git checkout develop
git merge --no-ff feature/stage1-logger
git push origin develop

# 4. 删除功能分支
git branch -d feature/stage1-logger
```

#### 3.2.4 修复分支（bugfix/*）
- **命名**: `bugfix/问题描述`
- **示例**: `bugfix/fix-rotation-angle`, `bugfix/memory-leak`
- **来源**: 从 `develop` 创建
- **合并**: 合并�� `develop`
- **生命周期**: 修复完成后删除

#### 3.2.5 发布分支（release/*）
- **命名**: `release/v版本号`
- **示例**: `release/v0.1.0`, `release/v1.0.0`
- **来源**: 从 `develop` 创建
- **合并**: 同时合并到 `main` 和 `develop`
- **生命周期**: 发布完成后删除

**发布流程**:
```bash
# 1. 创建发布分支
git checkout develop
git checkout -b release/v0.1.0

# 2. 版本号更新、文档完善、最后测试
# 修改版本号、更新CHANGELOG等

# 3. 合并到main并打标签
git checkout main
git merge --no-ff release/v0.1.0
git tag -a v0.1.0-stage0 -m "Release Stage 0: Environment Setup"
git push origin main --tags

# 4. 合并回develop
git checkout develop
git merge --no-ff release/v0.1.0

# 5. 删除发布分支
git branch -d release/v0.1.0
```

#### 3.2.6 紧急修复分支（hotfix/*）
- **命名**: `hotfix/紧急问题`
- **示例**: `hotfix/critical-crash`
- **来源**: 从 `main` 创建
- **合并**: 同时合并到 `main` 和 `develop`
- **生命周期**: 修复完成后删除

---

## 4. 标签管理

### 4.1 标签类型

#### 4.1.1 阶段标签（Stage Tags）
标记每个开发阶段的完成点：

```bash
v0.1.0-stage0    # 阶段0完成
v0.2.0-stage1    # 阶段1完成
v0.3.0-stage2    # 阶段2完成
...
```

#### 4.1.2 发布标签（Release Tags）
标记正式发布版本：

```bash
v1.0.0           # 正式发布
v1.1.0           # 功能更新
v1.0.1           # 问题修复
```

#### 4.1.3 预发布标签（Pre-release Tags）
标记测试版本：

```bash
v1.0.0-alpha.1   # Alpha测试版
v1.0.0-beta.1    # Beta测试版
v1.0.0-rc.1      # Release Candidate
```

### 4.2 标签创建规范

**附注标签（推荐）**:
```bash
git tag -a v0.1.0-stage0 -m "Stage 0 Complete: Environment Setup and Technical Planning

Completed:
- Project specification system established
- Documentation standards defined
- Development environment configured
- Directory structure created

Next: Stage 1 - Core Framework Development"

git push origin v0.1.0-stage0
```

**轻量标签（不推荐）**:
```bash
git tag v0.1.0-stage0
git push origin v0.1.0-stage0
```

### 4.3 标签命名规则

| 标签类型 | 格式 | 示例 |
|---------|------|------|
| 阶段标签 | `v次版本号.0-stage阶段号` | `v0.1.0-stage0` |
| 正式版本 | `v主.次.修订` | `v1.0.0` |
| Alpha版本 | `v主.次.修订-alpha.序号` | `v1.0.0-alpha.1` |
| Beta版本 | `v主.次.修订-beta.序号` | `v1.0.0-beta.1` |
| RC版本 | `v主.次.修订-rc.序号` | `v1.0.0-rc.1` |

---

## 5. 提交信息规范

### 5.1 提交信息格式
采用 **Conventional Commits** 规范：

```
<类型>(<范围>): <简短描述>

[可选的详细描述]

[可选的脚注]
```

### 5.2 提交类型

| 类型 | 说明 | 示例 |
|------|------|------|
| `feat` | 新功能 | `feat(grid): add rotation animation` |
| `fix` | 修复Bug | `fix(audio): resolve memory leak in sound player` |
| `docs` | 文档变更 | `docs(api): update integration guide` |
| `style` | 代码格式（不影响功能） | `style(core): format code with black` |
| `refactor` | 重构（不改变功能） | `refactor(level): simplify loader logic` |
| `perf` | 性能优化 | `perf(render): optimize sprite batching` |
| `test` | 测试相关 | `test(grid): add unit tests for rotation` |
| `chore` | 构建/工具变更 | `chore(deps): update pygame to 2.5.2` |
| `ci` | CI配置变更 | `ci: add automated testing workflow` |

### 5.3 提交示例

**好的提交**:
```bash
feat(logger): implement structured logging system

- Add GameLogger class with JSON formatting
- Implement log rotation (10MB, 5 backups)
- Add performance logging decorator
- Create default logging configuration

Closes #12
```

**不好的提交**:
```bash
update files
fix bug
WIP
```

### 5.4 提交频率建议
- ✅ 每完成一个小功能就提交
- ✅ 每修复一个Bug就提交
- ✅ 每天至少提交一次
- ❌ 不要积累大量修改后一次性提交

---

## 6. 阶段性版本控制流程

### 6.1 阶段开始
```bash
# 1. 从develop创建阶段分支（可选）
git checkout develop
git checkout -b stage1-development

# 2. 创建功能分支
git checkout -b feature/stage1-logger
```

### 6.2 阶段开发
```bash
# 日常开发循环
git add .
git commit -m "feat(logger): add JSON formatter"
git push origin feature/stage1-logger

# 功能完成后合并到develop
git checkout develop
git merge --no-ff feature/stage1-logger
```

### 6.3 阶段完成
```bash
# 1. 创建发布分支
git checkout develop
git checkout -b release/v0.2.0

# 2. 更新版本信息
# - 更新CHANGELOG.md
# - 更新版本号
# - 最后测试

# 3. 合并到main并打标签
git checkout main
git merge --no-ff release/v0.2.0
git tag -a v0.2.0-stage1 -m "Stage 1 Complete: Core Framework Development"
git push origin main --tags

# 4. 合并回develop
git checkout develop
git merge --no-ff release/v0.2.0

# 5. 清理
git branch -d release/v0.2.0
```

### 6.4 阶段回滚
```bash
# 查看所有标签
git tag -l

# 回滚到指定阶段
git checkout v0.1.0-stage0

# 基于该标签创建新分支
git checkout -b rollback-to-stage0
```

---

## 7. 版本控制检查清单

### 7.1 每日检查
- [ ] 提交信息符合规范
- [ ] 代码已推送到远程仓库
- [ ] 分支命名正确
- [ ] 无未追踪的重要文件

### 7.2 功能完成检查
- [ ] 功能分支已合并到develop
- [ ] 本地功能分支已删除
- [ ] 远程功能分支已删除
- [ ] 代码审查已通过

### 7.3 阶段完成检查
- [ ] 所有功能已合并到develop
- [ ] 发布分支已创建
- [ ] CHANGELOG已更新
- [ ] 版本号已更新
- [ ] 所有测试通过
- [ ] 文档已更新
- [ ] 已合并到main
- [ ] 标签已创建并推送
- [ ] 已合并回develop
- [ ] 发布分支已删除

---

## 8. 工具与自动化

### 8.1 推荐工具
- **Git GUI**: GitKraken, SourceTree, GitHub Desktop
- **命令行增强**: tig, lazygit
- **提交规范检查**: commitlint
- **版本号管理**: bump2version

### 8.2 Git配置建议
```bash
# 设置用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 设置默认编辑器
git config --global core.editor "code --wait"

# 设置别名
git config --global alias.st status
git config --global alias.co checkout
git config --global alias.br branch
git config --global alias.ci commit
git config --global alias.lg "log --graph --oneline --decorate --all"

# 设置自动换行
git config --global core.autocrlf true  # Windows
git config --global core.autocrlf input # Mac/Linux
```

### 8.3 .gitignore配置
参见项目根目录的 `.gitignore` 文件。

---

## 9. 常见问题

### 9.1 如何查看某个阶段的代码？
```bash
# 查看所有标签
git tag -l

# 切换到指定阶段
git checkout v0.2.0-stage1

# 查看该阶段的文件
ls -la
```

### 9.2 如何比较两个阶段的差异？
```bash
# 比较两个标签之间的差异
git diff v0.1.0-stage0 v0.2.0-stage1

# 查看文件列表差异
git diff --name-only v0.1.0-stage0 v0.2.0-stage1

# 查看统计信息
git diff --stat v0.1.0-stage0 v0.2.0-stage1
```

### 9.3 如何删除错误的标签？
```bash
# 删除本地标签
git tag -d v0.1.0-stage0

# 删除远程标签
git push origin :refs/tags/v0.1.0-stage0
```

### 9.4 如何修改最后一次提交？
```bash
# 修改提交信息
git commit --amend -m "new message"

# 添加遗漏的文件
git add forgotten_file.py
git commit --amend --no-edit
```

---

## 10. 最佳实践

### 10.1 提交原则
1. **原子性**: 每次提交只做一件事
2. **完整性**: 提交的代码可编译、可运行
3. **描述性**: 提交信息清晰描述变更内容
4. **频繁性**: 小步快跑，频繁提交

### 10.2 分支原则
1. **短生命周期**: 功能分支尽快合并
2. **单一职责**: 一个分支只做一件事
3. **及时清理**: 合并后立即删除分支
4. **保持同步**: 定期从主分支同步更新

### 10.3 标签原则
1. **有意义**: 标签名清晰表达版本含义
2. **附注标签**: 使用附注标签记录详细信息
3. **不可变**: 标签创建后不要修改
4. **及时推送**: 创建标签后立即推送到远程

---

## 11. 参考资料

- [Semantic Versioning 2.0.0](https://semver.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Git Flow](https://nvie.com/posts/a-successful-git-branching-model/)
- [Pro Git Book](https://git-scm.com/book/zh/v2)

---

## 12. 文档变更记录

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| v1.0.0 | 2026-01-20 | Claude | 初始版本，建立完整的版本控制规范体系 |

---

**重要提示**:
1. 本规范是强制性的，所有团队成员必须遵守
2. 违反规范的提交可能被拒绝或回退
3. 如有疑问，请参考本文档或咨询技术负责人
4. 本规范会根据项目实际情况持续优化
